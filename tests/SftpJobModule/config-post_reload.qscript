#!/usr/bin/env qore

%new-style
%requires QorusClientCore

QorusClient::init();

hash cfg = {
    # configure the first polling job (which doesn't move files to processing dir)
    "jobs/polling-test-job": {
        "sftp_connection_name": "sftp-local-test",
        "rejection_wf_name": "POLLING-TEST-REJECTION-WF",
        "wf_name": "POLLING-TEST-PROCESS-WF",
        "wf_unique_key": "{\"filename\": \"$local:filename\",}",
        "rejection_wf_unique_key": "{}",
        "regex_mask": "test1_.*",
    },

    # configure the first workflow (which doesn't expect files to be moved to processing dir)
    "workflows/POLLING-TEST-PROCESS-WF": {
        "sftp_connection_name": "sftp-local-test",
    },
    "workflows/POLLING-TEST-PROCESS-WF/stepinfo/PollingTestProcess_MoveFileToProcessing": {
        "input_data": '
            orig_file_path: $static:file_path
            new_file_path: $config:new_file_path
        ',
        "new_file_path": "processing/$local:orig_file_name.$local:wfiid",
    },
    "workflows/POLLING-TEST-PROCESS-WF/stepinfo/PollingTestProcess_DownloadToLocal": {
        "local_file_path": "/tmp/$local:sftp_file_name",
    },
    "workflows/POLLING-TEST-PROCESS-WF/stepinfo/PollingTestProcess_UploadFile": {
        "sftp_file_path": "upload/$local:local_file_name",
    },

    # configure the rejection workflow
    "workflows/POLLING-TEST-REJECTION-WF": {
        "sftp_connection_name": "sftp-local-test",
    },
    "workflows/POLLING-TEST-REJECTION-WF/stepinfo/PollingTestRejection_MoveFileToRejected": {
        "input_data": '
            orig_file_path: $static:file_path
            new_file_path: $config:new_file_path
        ',
        "new_file_path": "rejected/$local:filename.$local:wfiid",
    },

    # configure the second job (which does move files to processing dir)
    "jobs/polling-test-job2": {
        "sftp_connection_name": "sftp-local-test",
        "rejection_wf_name": "POLLING-TEST-REJECTION-WF",
        "wf_name": "POLLING-TEST-PROCESS2-WF",
        "wf_unique_key": "{\"filename\": \"$local:filename\",}",
        "rejection_wf_unique_key": "{}",
        "processing_path": "processing",
        "regex_mask": "test2_.*",
    },

    # configure the second workflow (which does expect files to be moved to processing dir)
    "workflows/POLLING-TEST-PROCESS2-WF": {
        "sftp_connection_name": "sftp-local-test",
    },
    "workflows/POLLING-TEST-PROCESS2-WF/stepinfo/PollingTestProcess2_DownloadToLocal": {
        "local_file_path": "/tmp/$local:sftp_file_name",
        "input_data": '
            sftp_file_path: $static:file_path
            local_file_path: $config:local_file_path
        ',
    },
    "workflows/POLLING-TEST-PROCESS2-WF/stepinfo/PollingTestProcess2_UploadFile": {
        "sftp_file_path": "upload/$local:local_file_name.$local:wfiid",
    },
};

foreach hash cfg_iterator in (cfg.pairIterator()) {
    foreach hash cfg_item in (cfg_iterator.value.pairIterator()) {
        string path = sprintf("%s/config/%s?action=yaml", cfg_iterator.key, cfg_item.key);
        printf("executing PUT %s\n", path);
        qrest.put(NOTHING, path, {"value": cfg_item.value});
    }
}
